openapi: 3.0.3
info:
  title: FocusFlow API
  description: |
    ADHD-friendly focus tool API providing task management, Pomodoro timer sessions,
    habit tracking, and brain dump functionality.

    ## Key Features
    - **Task Management**: CRUD operations for tasks and micro-steps with drag-and-drop reordering
    - **Pomodoro Sessions**: Focus and break timer management
    - **Brain Dump**: Quick capture of intrusive thoughts
    - **Habit Tracking**: Daily habits with streak calculation
    - **User Settings**: Customizable focus/break durations and themes

    ## Design Principles
    - RESTful API design with standard HTTP methods
    - Idempotent operations for offline sync reliability
    - Comprehensive error responses
    - Optimistic locking support (ETags)

  version: 1.0.0
  contact:
    name: FocusFlow API Support
    email: support@focusflow.app

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: http://localhost:8000/api/v1
    description: Production server (placeholder)

tags:
  - name: tasks
    description: Task and micro-step management
  - name: pomodoro
    description: Pomodoro timer sessions
  - name: brain-dump
    description: Quick thought capture
  - name: habits
    description: Habit tracking and streaks
  - name: settings
    description: User preferences

paths:
  # ==================== TASKS ====================
  /tasks:
    get:
      summary: List all tasks
      description: Retrieve all tasks with optional filtering and sorting. Includes nested micro-steps.
      tags: [tasks]
      parameters:
        - name: completed
          in: query
          description: Filter by completion status
          schema:
            type: boolean
        - name: sort_by
          in: query
          description: Sort field
          schema:
            type: string
            enum: [created_at, updated_at, order, title]
            default: order
        - name: sort_order
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  total:
                    type: integer
                    description: Total number of tasks
              example:
                tasks:
                  - id: "task-123"
                    title: "Write research report"
                    description: null
                    completed: false
                    order: 0
                    created_at: "2026-01-06T12:00:00Z"
                    updated_at: "2026-01-06T12:00:00Z"
                    micro_steps: []
                total: 1

    post:
      summary: Create a new task
      description: Create a task with optional micro-steps
      tags: [tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
            example:
              title: "Complete project proposal"
              description: "Draft and review proposal for Q2 project"
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/ValidationError'

  /tasks/{task_id}:
    get:
      summary: Get task by ID
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update task
      description: Update task fields. Supports partial updates.
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
            example:
              title: "Complete project proposal (revised)"
              completed: false
      responses:
        '200':
          description: Task updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'

    delete:
      summary: Delete task
      description: Delete task and all associated micro-steps (cascade)
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
      responses:
        '204':
          description: Task deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  /tasks/reorder:
    put:
      summary: Bulk reorder tasks
      description: Update order field for multiple tasks (drag-and-drop support)
      tags: [tasks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                tasks:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      order:
                        type: integer
                        minimum: 0
                    required: [id, order]
            example:
              tasks:
                - id: "task-123"
                  order: 0
                - id: "task-456"
                  order: 1
      responses:
        '200':
          description: Tasks reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  updated_count:
                    type: integer
        '400':
          $ref: '#/components/responses/BadRequest'

  /tasks/{task_id}/micro-steps:
    post:
      summary: Add micro-step to task
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MicroStepCreate'
            example:
              title: "Research competitive analysis"
      responses:
        '201':
          description: Micro-step created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MicroStep'
        '404':
          $ref: '#/components/responses/NotFound'

  /tasks/{task_id}/micro-steps/{microstep_id}:
    put:
      summary: Update micro-step
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
        - name: microstep_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  maxLength: 500
                completed:
                  type: boolean
                order:
                  type: integer
                  minimum: 0
      responses:
        '200':
          description: Micro-step updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MicroStep'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete micro-step
      tags: [tasks]
      parameters:
        - $ref: '#/components/parameters/TaskId'
        - name: microstep_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Micro-step deleted
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== POMODORO ====================
  /pomodoro/sessions:
    get:
      summary: List Pomodoro sessions
      description: Retrieve session history with optional filtering
      tags: [pomodoro]
      parameters:
        - name: task_id
          in: query
          description: Filter by task ID
          schema:
            type: string
            format: uuid
        - name: session_type
          in: query
          description: Filter by session type
          schema:
            type: string
            enum: [focus, break]
        - name: state
          in: query
          description: Filter by state
          schema:
            type: string
            enum: [running, paused, completed, cancelled]
        - name: limit
          in: query
          description: Number of sessions to return
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/PomodoroSession'
                  total:
                    type: integer

    post:
      summary: Start a new Pomodoro session
      tags: [pomodoro]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PomodoroSessionCreate'
            example:
              task_id: "task-123"
              session_type: "focus"
              duration_minutes: 25
      responses:
        '201':
          description: Session started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PomodoroSession'
        '400':
          $ref: '#/components/responses/BadRequest'

  /pomodoro/sessions/{session_id}:
    get:
      summary: Get session by ID
      tags: [pomodoro]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PomodoroSession'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update session state
      description: Pause, resume, complete, or cancel a session
      tags: [pomodoro]
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                  enum: [paused, running, completed, cancelled]
              required: [state]
            example:
              state: "paused"
      responses:
        '200':
          description: Session updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PomodoroSession'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /pomodoro/sessions/active:
    get:
      summary: Get active session
      description: Returns currently running or paused session, if any
      tags: [pomodoro]
      responses:
        '200':
          description: Active session found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PomodoroSession'
        '404':
          description: No active session
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "No active session"

  /pomodoro/stats/today:
    get:
      summary: Get today's Pomodoro statistics
      tags: [pomodoro]
      responses:
        '200':
          description: Statistics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  completed_focus_sessions:
                    type: integer
                    description: Number of completed focus sessions today
                  completed_break_sessions:
                    type: integer
                  total_focus_minutes:
                    type: integer
                  date:
                    type: string
                    format: date
              example:
                completed_focus_sessions: 4
                completed_break_sessions: 3
                total_focus_minutes: 100
                date: "2026-01-06"

  # ==================== BRAIN DUMP ====================
  /brain-dump:
    get:
      summary: List brain dump entries
      description: Retrieve entries with optional status filtering
      tags: [brain-dump]
      parameters:
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [inbox, converted, dismissed]
            default: inbox
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/BrainDumpEntry'
                  total:
                    type: integer

    post:
      summary: Create brain dump entry
      description: Quick capture of a thought or idea
      tags: [brain-dump]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  minLength: 1
                  maxLength: 10000
              required: [content]
            example:
              content: "Remember to email client about project timeline"
      responses:
        '201':
          description: Entry created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDumpEntry'
        '400':
          $ref: '#/components/responses/BadRequest'

  /brain-dump/{entry_id}:
    put:
      summary: Update brain dump entry
      tags: [brain-dump]
      parameters:
        - name: entry_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  maxLength: 10000
                status:
                  type: string
                  enum: [inbox, converted, dismissed]
      responses:
        '200':
          description: Entry updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDumpEntry'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete brain dump entry
      tags: [brain-dump]
      parameters:
        - name: entry_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Entry deleted
        '404':
          $ref: '#/components/responses/NotFound'

  /brain-dump/{entry_id}/convert-to-task:
    post:
      summary: Convert brain dump entry to task
      tags: [brain-dump]
      parameters:
        - name: entry_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Task created from entry
          content:
            application/json:
              schema:
                type: object
                properties:
                  task:
                    $ref: '#/components/schemas/Task'
                  entry:
                    $ref: '#/components/schemas/BrainDumpEntry'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== HABITS ====================
  /habits:
    get:
      summary: List habits
      tags: [habits]
      parameters:
        - name: archived
          in: query
          description: Include archived habits
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  habits:
                    type: array
                    items:
                      $ref: '#/components/schemas/Habit'

    post:
      summary: Create habit
      tags: [habits]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 200
              required: [name]
            example:
              name: "Morning meditation"
      responses:
        '201':
          description: Habit created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Habit'
        '400':
          $ref: '#/components/responses/BadRequest'

  /habits/{habit_id}:
    get:
      summary: Get habit by ID
      tags: [habits]
      parameters:
        - name: habit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Habit'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update habit
      tags: [habits]
      parameters:
        - name: habit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 200
                archived:
                  type: boolean
      responses:
        '200':
          description: Habit updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Habit'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete habit
      description: Deletes habit and all check-ins (cascade)
      tags: [habits]
      parameters:
        - name: habit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Habit deleted
        '404':
          $ref: '#/components/responses/NotFound'

  /habits/{habit_id}/check-in:
    post:
      summary: Check in habit for today
      description: Mark habit as complete for today. Idempotent - returns existing check-in if already completed.
      tags: [habits]
      parameters:
        - name: habit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Check-in recorded or already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  check_in:
                    $ref: '#/components/schemas/HabitCheckIn'
                  streak:
                    type: integer
                    description: Current streak count
                  message:
                    type: string
              example:
                check_in:
                  id: "checkin-123"
                  habit_id: "habit-456"
                  completed_at: "2026-01-06T08:30:00Z"
                streak: 7
                message: "Habit checked in for today"
        '404':
          $ref: '#/components/responses/NotFound'

  /habits/{habit_id}/streak:
    get:
      summary: Get habit streak
      tags: [habits]
      parameters:
        - name: habit_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Streak calculated
          content:
            application/json:
              schema:
                type: object
                properties:
                  streak:
                    type: integer
                  last_check_in:
                    type: string
                    format: date-time
                    nullable: true
              example:
                streak: 7
                last_check_in: "2026-01-06T08:30:00Z"
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== SETTINGS ====================
  /settings:
    get:
      summary: Get user settings
      tags: [settings]
      responses:
        '200':
          description: Settings retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'

    put:
      summary: Update user settings
      description: Supports partial updates
      tags: [settings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSettingsUpdate'
            example:
              focus_duration_minutes: 30
              theme: "dark"
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserSettings'
        '400':
          $ref: '#/components/responses/BadRequest'

# ==================== COMPONENTS ====================
components:
  parameters:
    TaskId:
      name: task_id
      in: path
      required: true
      description: Task UUID
      schema:
        type: string
        format: uuid

  schemas:
    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 500
        description:
          type: string
          nullable: true
        completed:
          type: boolean
        order:
          type: integer
          minimum: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        micro_steps:
          type: array
          items:
            $ref: '#/components/schemas/MicroStep'
      required:
        - id
        - title
        - completed
        - order
        - created_at
        - updated_at

    TaskCreate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: string
          maxLength: 10000
          nullable: true
      required:
        - title

    TaskUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
        description:
          type: string
          maxLength: 10000
          nullable: true
        completed:
          type: boolean
        order:
          type: integer
          minimum: 0

    MicroStep:
      type: object
      properties:
        id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 500
        completed:
          type: boolean
        order:
          type: integer
          minimum: 0
        created_at:
          type: string
          format: date-time

    MicroStepCreate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
      required:
        - title

    PomodoroSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
          nullable: true
        session_type:
          type: string
          enum: [focus, break]
        duration_minutes:
          type: integer
          minimum: 1
        state:
          type: string
          enum: [running, paused, completed, cancelled]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        paused_duration_ms:
          type: integer
          description: Total time paused in milliseconds

    PomodoroSessionCreate:
      type: object
      properties:
        task_id:
          type: string
          format: uuid
          nullable: true
        session_type:
          type: string
          enum: [focus, break]
        duration_minutes:
          type: integer
          minimum: 1
          maximum: 60
      required:
        - session_type
        - duration_minutes

    BrainDumpEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        status:
          type: string
          enum: [inbox, converted, dismissed]
        created_at:
          type: string
          format: date-time
        processed_at:
          type: string
          format: date-time
          nullable: true
        converted_to_task_id:
          type: string
          format: uuid
          nullable: true

    Habit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 200
        created_at:
          type: string
          format: date-time
        archived:
          type: boolean
        current_streak:
          type: integer
          description: Calculated current streak

    HabitCheckIn:
      type: object
      properties:
        id:
          type: string
          format: uuid
        habit_id:
          type: string
          format: uuid
        completed_at:
          type: string
          format: date-time

    UserSettings:
      type: object
      properties:
        id:
          type: integer
          example: 1
        focus_duration_minutes:
          type: integer
          minimum: 1
          maximum: 60
          default: 25
        break_duration_minutes:
          type: integer
          minimum: 1
          maximum: 30
          default: 5
        audio_enabled:
          type: boolean
          default: true
        theme:
          type: string
          enum: [light, dark]
          default: dark
        color_scheme:
          type: string
          enum: [default, forest]
          default: default
        timezone:
          type: string
          example: "America/New_York"
        updated_at:
          type: string
          format: date-time

    UserSettingsUpdate:
      type: object
      properties:
        focus_duration_minutes:
          type: integer
          minimum: 1
          maximum: 60
        break_duration_minutes:
          type: integer
          minimum: 1
          maximum: 30
        audio_enabled:
          type: boolean
        theme:
          type: string
          enum: [light, dark]
        color_scheme:
          type: string
          enum: [default, forest]
        timezone:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
        status_code:
          type: integer
      required:
        - error
        - status_code

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Bad Request"
            detail: "Invalid request format"
            status_code: 400

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not Found"
            detail: "Resource with specified ID does not exist"
            status_code: 404

    ValidationError:
      description: Validation error - invalid field values
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              validation_errors:
                type: array
                items:
                  type: object
                  properties:
                    field:
                      type: string
                    message:
                      type: string
          example:
            error: "Validation Error"
            validation_errors:
              - field: "title"
                message: "Title must be at least 1 character"
